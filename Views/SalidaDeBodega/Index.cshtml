@model IEnumerable<Inventario360.Models.SalidaDeBodega>

@{
    ViewData["Title"] = "Salidas de Bodega";
}

<div class="container mt-4">
    <h2 class="mb-4">Salidas de Bodega</h2>

    <div class="text-end mb-3">
        <a asp-action="Crear" class="btn btn-secondary">Registrar Salida</a>
    </div>

    <div class="table-responsive">
        <table id="salidasTable" class="table table-striped table-bordered nowrap" width="100%">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Solicitante</th>
                    <th>Responsable de Entrega</th>
                    <th>Proyecto</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var salida in Model)
                {
                    <tr id="fila-@salida.ID">
                        <td>@salida.ID</td>
                        <td>@(salida.Fecha?.ToString("dd-MM-yyyy HH:mm") ?? "Sin fecha")</td>
                        <td>@(salida.SolicitanteObj?.Nombre ?? "No asignado")</td>
                        <td>@(salida.ResponsableEntregaObj?.Nombre ?? "No asignado")</td>
                        <td>@(salida.ProyectoObj?.Nombre ?? "No asignado")</td>
                        <td>
                            <a asp-action="Details" asp-route-id="@salida.ID" class="btn btn-icon">🔍</a>
                            <button type="button" class="btn btn-icon" onclick="confirmarEliminacion(@salida.ID)">🗑️</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmarEliminarLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                ¿Seguro que deseas eliminar esta salida de bodega?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var salidaIdAEliminar = null;

        function confirmarEliminacion(id) {
            salidaIdAEliminar = id;
            var modal = new bootstrap.Modal(document.getElementById('confirmarEliminarModal'));
            modal.show();
        }

        $(document).ready(function () {
            $("#btnConfirmarEliminar").click(function () {
                if (salidaIdAEliminar) {
                    $.ajax({
                        url: "/SalidaDeBodega/Eliminar",
                        type: "POST",
                        data: { id: salidaIdAEliminar },
                        success: function (response) {
                            if (response.success) {
                                $("#fila-" + salidaIdAEliminar).fadeOut(300, function () { $(this).remove(); });
                                $("#confirmarEliminarModal").modal('hide');
                            } else {
                                alert("Error: " + response.message);
                            }
                        },
                        error: function () {
                            alert("Hubo un error al eliminar la salida de bodega.");
                        }
                    });
                }
            });
        });
    </script>
}
